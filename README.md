# Die Hard

This is a project with a test task for backend developers.

You can find detailed requirements by clicking the links:
- [English version](docs/task_en.md)
- [Russian version](docs/task_ru.md)

Tech stack:
- Python 3.13
- Django 5
- pytest
- Docker & docker-compose
- PostgreSQL
- ClickHouse

## Installation

Put a `.env` file into the `src/core` directory. You can start with a template file:

```
cp src/core/.env.ci src/core/.env
```

Run the containers with
```
make run
```

and then run the installation script with:

```
make install
```

## Tests

`make test`

## Linter

`make lint`

---

## Решение и Обоснование

### Обзор Решения

Для решения поставленной задачи был выбран шаблон транзакционного Outbox, который гарантирует согласованность данных между основной базой данных PostgreSQL и ClickHouse. Этот подход позволяет избежать потери событий в случае сбоев системы и минимизировать количество вставок в ClickHouse через пакетирование.

### Архитектурные Решения

1. **Transactional Outbox Pattern**:
    - **Причина выбора**: Обеспечивает атомарность записи событий вместе с основной бизнес-логикой, предотвращая потерю данных при сбоях.

2. **Пакетирование Вставок в ClickHouse**:
    - **Причина выбора**: Большое количество мелких вставок негативно влияет на производительность ClickHouse (*как и в любую колоночную БД*). Пакетирование снижает нагрузку и улучшает эффективность вставок. Было выбрано произвольно значение 1000 событий в один батч, однако с этим можно поэкспериментировать на реальной практике (рекомендуемо в диапазоне 1к-10к)

### Аудит Инцидентов при Проблемах с Batch Insert в ClickHouse

Batch Insert - довольно простой механизм, но имеет слабость. В случае битого сообщения, даже одного, будет падать весь пакет. Дабы преодолеть эти проблемы, был разработан механизм аудита инцидентов, путем дополнительно модели `BatchFailure`, которая содержит информацию о неудачных событиях и причине ошибки.

В процессе реализации был реализован механизм аудита инцидентов, связанных с проблемами при пакетных вставках в ClickHouse. Это включает:

- **Логирование ошибок**: Все ошибки при вставках регистрируются с помощью `structlog`, что облегчает диагностику проблем.
- **Запись неудачных батчей**: В случае сбоя вставки создается запись в модели `BatchFailure`, содержащая информацию о неудачных событиях и причине ошибки.
- **Автоматические повторные попытки**: Задачи Celery настроены на повторные попытки выполнения при возникновении ошибок, что повышает надежность системы.
- **Отслеживание статусов событий**: Статусы событий (`PENDING`, `FAILED`, `COMPLETED`) позволяют отслеживать состояние обработки каждого события и предпринимать необходимые меры в случае неудач.

**Из нереализованного**:
Интерфейс для просмотра и анализа логов ошибок и неудачных батчей, а также управления разрешением инцидента. В моем видении, при каких-то проблемах (например, некорректная запись в модель Pydantic, которую не выходит дампить для кликхауса) разработчик сможет накатить миграцию, и в рамках нее через этот интерфейс обновить связанные логи неудачных батчей. После обновления условия вновь будут проходить для исправленных логов.

### Тестирование

Для обеспечения надежности решения были реализованы тесты. Возможно, они слишком замудренные, но это не моя сильная сторона.

### Возможные улучшения

В рамках доступного мне времени некоторые детали не успел реализовать. Однако, я бы добавил следующее (в порядке приоритета)

- **API для просмотра и анализа логов ошибок и неудачных батчей**
- **мониторинг и алёрты**: Интеграция с инструментами мониторинга, такими как Prometheus или Grafana, для отслеживания состояния задач и производительности.
- **GitHub Actions для CI/CD**